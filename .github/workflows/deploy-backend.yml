name: deploy-backend
on:
  push:
    branches: [ main ]
    paths:
      - 'api/**'
      - 'src/**'
      - 'public/**'
      - 'discover_analysis/**'
      - 'package.json'
      - 'index.html'
      - 'package-lock.json'
      - 'vite.config.ts'
      - 'requirements.txt'
      - '.github/workflows/deploy-backend.yml'
permissions:
  id-token: write
  contents: read
jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: prod
    steps:
      - uses: actions/checkout@v4

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Show Node & npm versions
        run: |
          node -v
          npm -v

      # This step is robust for MANUAL uploads:
      # - If lockfile matches: npm ci (fast, deterministic)
      # - If lockfile is missing or out-of-sync: falls back to npm install
      - name: Install deps (prefer ci, fallback to install)
        shell: bash
        run: |
          if [ -f package-lock.json ]; then
            echo "Attempting npm ci..."
            npm ci || (echo "npm ci failed, trying npm install..." && npm install)
          else
            echo "No lockfile found, running npm install..."
            npm install
          fi

      - name: Build frontend
        run: npm run build

      - name: Push app settings + enable websockets
        run: |
          az webapp config appsettings set -g suproc-resource -n suproc --settings \
            OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}" \
            SERPER_API_KEY="${{ secrets.SERPER_API_KEY }}" \
            DEEPSEEK_API_KEY="${{ secrets.DEEPSEEK_API_KEY }}" \
            TAVILY_API_KEY="${{ secrets.TAVILY_API_KEY }}" \
            MASTER_SUPABASE_URL="${{ secrets.MASTER_SUPABASE_URL }}" \
            MASTER_SUPABASE_KEY="${{ secrets.MASTER_SUPABASE_KEY }}" \
            TURNSTILE_SECRET_KEY="${{ secrets.TURNSTILE_SECRET_KEY }}" \
            APP_ENCRYPTION_KEY="${{ secrets.APP_ENCRYPTION_KEY }}" \
            VITE_SUPABASE_URL="${{ secrets.VITE_SUPABASE_URL }}" \
            VITE_SUPABASE_ANON_KEY="${{ secrets.VITE_SUPABASE_ANON_KEY }}" \
            VITE_TURNSTILE_SITE_KEY="${{ secrets.VITE_TURNSTILE_SITE_KEY }}" \
            CORS_ALLOWED_ORIGINS="*" \
            SCM_DO_BUILD_DURING_DEPLOYMENT=1
          az webapp config set -g suproc-resource -n suproc --linux-fx-version 'PYTHON|3.11' --web-sockets-enabled true --ftps-state Disabled

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install backend deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Package site (api + dist + discover_analysis)
        run: zip -r backend.zip api requirements.txt dist discover_analysis

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: suproc
          package: ./backend.zip
